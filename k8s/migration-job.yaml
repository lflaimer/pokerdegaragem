apiVersion: batch/v1
kind: Job
metadata:
  name: poker-migrate
  namespace: poker-app
  labels:
    app: poker-app
    component: migration
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: migrate
          # Replace with your actual container registry image (dev image with prisma CLI)
          image: poker-de-garagem-dev:latest
          imagePullPolicy: IfNotPresent
          command:
            - sh
            - -c
            - |
              echo "Running database migrations..."
              npx prisma migrate deploy
              echo "Migrations complete!"
          env:
            - name: DATABASE_URL
              value: "mysql://poker:$(MYSQL_PASSWORD)@mysql:3306/poker_db"
            - name: MYSQL_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: poker-secrets
                  key: MYSQL_PASSWORD
      initContainers:
        - name: wait-for-mysql
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              until nc -z mysql 3306; do
                echo "Waiting for MySQL..."
                sleep 2
              done
              echo "MySQL is ready!"
